# Enable Delivery Optimization for Enterprise Network
# This script configures Delivery Optimization settings for enterprise environments
$ScriptName = & {$MyInvocation.ScriptName}
$ScriptPath = Split-Path -Parent $ScriptName
$ScriptName = Split-Path -Leaf $ScriptName

# Writing log file path
$logFile = "$ScriptPath\$ScriptName"+"Log.txt"

#Log function to write messages to log file
function LogMessage {
    param (
        [string]$message
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "$timestamp - $message"
    Add-Content -Path $logFile -Value $logMessage
}



# Check for administrator privileges
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    LogMessage "You must run this script as an administrator!"
    exit
}

# Ensure delivery optimization module is availbele
try{
    import-module DeliveryOptimization -ErrorAction Stop
    LogMessage "DeliveryOptimization module imported successfully."
}
catch{
    LogMessage "Failed to import DeliveryOptimization module: $_"
    exit
}

# Set the download mode for Delivery Optimization as 1 (LAN mode)
try {
    # Set DODownloadMode via registry instead of Set-DODownloadMode
    Set-ItemProperty -Path $regPath -Name "DODownloadMode" -Value 1 -Type DWord -Force
    LogMessage "Delivery Optimization download mode set to LAN (1) via registry."
}
catch {
    LogMessage "Failed to set Delivery Optimization download mode: $_"
}

# Defining registry path
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeliveryOptimization"

#Ensure registry path exists
try {
    if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
        LogMessage "Created registry path: $regPath"
    } else {
        LogMessage "Registry path already exists: $regPath"
    }
}
catch {
    LogMessage "Failed to ensure registry path exists: $_"
    exit
}
# Set registry values with error handling and logging
function Set-DoRegistryValues {
    param (
        [string]$name,
        [object]$value
    )
    try {
        Set-ItemProperty -Path $regPath -Name $name -Value $value -Force
        LogMessage "Set $name to $value successfully."
    }
    catch {
        LogMessage "Failed to set registry value ${name}: ${_}"
    }
}
#Restrict peer caching to enterprise network only (already set above)
#Set maximum cache size to 20% of disk space
Set-DoRegistryValues -name "DOMaxCacheSize" -value 20
#Set maximum absolute size to 10 Gb (QWORD, in bytes)
$tenGB = 10 * 1024 * 1024 * 1024
Set-DoRegistryValues -name "DOMaxCacheSizeAbsolute" -value $tenGB
# Set maximum cache age to 5 days
Set-DoRegistryValues -name "DOMaxCacheAge" -value 5
# Disable Delivery optimization on metered connections
Set-DoRegistryValues -name "DOMeteredConnectionsEnabled" -value 0
#Disable peer catching on VPN connections
Set-DoRegistryValues -name "DOVPNEnabled" -value 0
LogMessage "Delivery Optimization settings have been configured successfully."